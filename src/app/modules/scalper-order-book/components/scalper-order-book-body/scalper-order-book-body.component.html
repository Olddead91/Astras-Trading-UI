<ng-container *ngrxLet="{ isLoading: isLoading$ } as vm">
  <nz-spin [nzSpinning]="vm.isLoading">
    <cdk-virtual-scroll-viewport
      (nzResizeObserve)="updateContentSize($event)"
      [itemSize]="rowHeight"
      [maxBufferPx]="rowHeight * 10"
      [minBufferPx]="rowHeight * 10"
      [orientation]="'vertical'"
      class="container show-scroll"
      nzResizeObserver>
      <ng-container *ngIf="dataContext">
        <ng-container *ngrxLet="{
        panelWidths: panelWidths$,
        orderBookBody: dataContext.orderBookBody$,
        extendedSettings: dataContext.extendedSettings$} as vm">
          <div id="spacer">
              <div *cdkVirtualFor="let row of vm.orderBookBody; templateCacheSize: 0"
                   [style.height]="rowHeight + 'px'"
                   [style.line-height]="rowHeight + 'px'"
              ></div>
            </div>
          <ng-container *ngIf="vm.orderBookBody.length > 0">
            <ats-panels-container
              class="w-100"
              [initialWidths]="vm.panelWidths"
              (widthUpdated)="updatePanelWidths($event)"
            >
              <ats-panel
                *ngIf="vm.extendedSettings.widgetSettings?.showTradesClustersPanel"
                [canResize]="true"
                [id]="panelIds.tradeClusters"
                [minWidthPx]="20"
                [defaultWidthPercent]="25"
                [expandable]="vm.extendedSettings.widgetSettings.showTradesPanel ?? false"
              >
                <ats-trade-clusters-panel
                  [dataContext]="dataContext"
                  [xAxisStep]="rowHeight"
                ></ats-trade-clusters-panel>
              </ats-panel>

              <ats-panel
                *ngIf="vm.extendedSettings.widgetSettings.showTradesPanel"
                [canResize]="true"
                [id]="panelIds.currentTrades"
                [minWidthPx]="40"
                [defaultWidthPercent]="25"
              >
                <ats-trades-panel
                  [dataContext]="dataContext"
                  [xAxisStep]="rowHeight"
                ></ats-trades-panel>
              </ats-panel>

              <ats-panel
                [id]="panelIds.ordersTable"
                [minWidthPx]="75"
                [defaultWidthPercent]="50"
              >
                <ats-scalper-order-book-table [dataContext]="dataContext"
                                              [isActive]="isActive"
                                              [rowHeight]="rowHeight"
                >
                </ats-scalper-order-book-table>
              </ats-panel>
            </ats-panels-container>
          </ng-container>
        </ng-container>
      </ng-container>
    </cdk-virtual-scroll-viewport>
    <div class="position-absolute top-0 end-0">
      <ats-orders-indicator [visible]="(hiddenOrdersIndicators$ | async)?.up ?? false"
                            direction="up"></ats-orders-indicator>
    </div>
    <div class="position-absolute bottom-0 end-0">
      <ats-orders-indicator [visible]="(hiddenOrdersIndicators$ | async)?.down ?? false"
                            direction="down"></ats-orders-indicator>
    </div>
    <div class="position-absolute bottom-0 w-100" id="possible-actions-panel-container">
      <ats-possible-actions-panel></ats-possible-actions-panel>
    </div>
    <div
      *ngIf="(dataContext.orderBookBody$  | async)?.length === 0 && !vm.isLoading"
      class="position-absolute top-0 w-100"
    >
      <nz-empty
        class="ant-list-empty-text"
        nzNotFoundImage="simple"
      ></nz-empty>
    </div>
</nz-spin>
</ng-container>
